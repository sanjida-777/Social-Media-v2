{% extends "base.html" %}

{% block title %}Home | {{ site_name }}{% endblock %}

{% block additional_css %}
<style>
    .story-carousel {
        display: flex;
        overflow-x: auto;
        gap: 15px;
        padding: 10px 5px;
        scrollbar-width: none; /* For Firefox */
    }

    .story-carousel::-webkit-scrollbar {
        display: none; /* For Chrome, Safari, and Opera */
    }

    .story-item {
        position: relative;
        min-width: 120px;
        height: 200px;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .story-item:hover {
        transform: translateY(-5px);
    }

    .story-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .story-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        color: white;
    }

    .story-avatar {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid var(--bs-primary);
        background-color: #fff;
    }

    .create-story {
        position: relative;
        background-color: var(--bs-dark);
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
    }

    .create-story-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--bs-primary);
        color: white;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .post-card {
        margin-bottom: 20px;
        border-radius: 10px;
        overflow: hidden;
    }

    .post-header {
        display: flex;
        align-items: center;
        padding: 12px 15px;
    }

    .post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .post-meta {
        flex-grow: 1;
    }

    .post-username {
        font-weight: bold;
        margin-bottom: 0;
    }

    .post-time {
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }

    .post-content {
        padding: 0 15px 15px;
    }

    .post-text {
        margin-bottom: 15px;
    }

    .post-images {
        position: relative;
        margin-bottom: 15px;
    }

    .post-image-grid {
        display: grid;
        grid-template-columns: 1fr;
        grid-gap: 2px;
        border-radius: 8px;
        overflow: hidden;
    }

    .post-image-grid.grid-2 {
        grid-template-columns: 1fr 1fr;
    }

    .post-image-grid.grid-3 {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .post-image-grid.grid-3 .post-image:first-child {
        grid-row: span 2;
    }

    .post-image-grid.grid-4 {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .post-image-grid.grid-5 {
        grid-template-columns: 2fr 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .post-image-grid.grid-5 .post-image:first-child {
        grid-row: span 2;
    }

    .post-image {
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        background-size: cover;
        background-position: center;
        position: relative;
    }

    .post-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }

    .post-actions {
        display: flex;
        justify-content: space-between;
        padding: 0 15px 15px;
    }

    .post-action-btn {
        background: none;
        border: none;
        color: var(--bs-secondary-color);
        font-size: 1.2rem;
        padding: 0;
        display: flex;
        align-items: center;
    }

    .post-action-btn:hover {
        color: var(--bs-primary);
    }

    .post-action-count {
        font-size: 0.9rem;
        margin-left: 5px;
    }

    .post-liked {
        color: var(--bs-primary);
    }

    .create-post-card {
        margin-bottom: 20px;
        border-radius: 10px;
        padding: 15px;
    }

    .create-post-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .create-post-input {
        flex-grow: 1;
        margin-left: 10px;
        background-color: var(--bs-dark-bg-subtle);
        border-radius: 20px;
        padding: 10px 15px;
        cursor: pointer;
    }

    .create-post-actions {
        display: flex;
        justify-content: space-around;
        border-top: 1px solid var(--bs-border-color);
        padding-top: 15px;
    }

    .create-post-action {
        display: flex;
        align-items: center;
        padding: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
    }

    .create-post-action:hover {
        background-color: var(--bs-dark-bg-subtle);
    }

    .create-post-action i {
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .right-sidebar {
        position: sticky;
        top: 20px;
    }

    .friend-suggestion {
        display: flex;
        align-items: center;
        padding: 10px 0;
    }

    .friend-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .friend-info {
        flex-grow: 1;
    }

    .friend-username {
        font-weight: bold;
        margin-bottom: 0;
    }

    .friend-meta {
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }

    .trending-tags {
        margin-top: 20px;
    }

    .tag-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }

    .tag-count {
        color: var(--bs-secondary-color);
        font-size: 0.9rem;
    }

    @media (max-width: 991.98px) {
        .right-sidebar {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Stories -->
        <div class="card mb-4">
            <div class="card-body p-2">
                <div class="story-carousel">
                    <!-- Create Story Button -->
                    <div class="story-item create-story">
                        <img src="{{ url_for('static', filename='images/default-avatar.svg') }}" alt="Your avatar" class="story-avatar">
                        <div class="create-story-button">
                            <i class="bi bi-plus"></i>
                        </div>
                        <div class="story-info">
                            <small>Create Story</small>
                        </div>
                    </div>

                    <!-- Story Items -->
                    {% for story in stories %}
                    <div class="story-item" data-story-id="{{ story.id }}">
                        <img src="{{ story.media_url or url_for('static', filename='images/story-default.jpg') }}" alt="Story by {{ story.author.username }}">
                        <img src="{{ story.author.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ story.author.username }}" class="story-avatar">
                        <div class="story-info">
                            <small>{{ story.author.username }}</small>
                        </div>
                    </div>
                    {% else %}
                    <!-- Empty state when no stories are available -->
                    <div class="story-item">
                        <img src="{{ url_for('static', filename='images/default-avatar.svg') }}" alt="User" class="story-avatar">
                        <div class="story-info">
                            <small>No stories yet</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Create Post -->
        <div class="card create-post-card mb-4">
            <div class="create-post-header">
                <img src="{{ g.user.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ g.user.username }}" class="post-avatar">
                <div class="create-post-input" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    What's on your mind, {{ g.user.username }}?
                </div>
            </div>
            <div class="create-post-actions">
                <div class="create-post-action" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    <i class="bi bi-image text-success"></i>
                    <span>Photo</span>
                </div>
                <div class="create-post-action" data-bs-toggle="modal" data-bs-target="#createStoryModal">
                    <i class="bi bi-clock-history text-primary"></i>
                    <span>Story</span>
                </div>
                <div class="create-post-action" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    <i class="bi bi-emoji-smile text-warning"></i>
                    <span>Feeling</span>
                </div>
            </div>
        </div>

        <!-- Posts Feed -->
        <div id="posts-container">
            {% for post in posts %}
            <div class="card post-card" data-post-id="{{ post.id }}">
                <div class="post-header">
                    <img src="{{ post.author.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ post.author.username }}" class="post-avatar">
                    <div class="post-meta">
                        <p class="post-username">{{ post.author.username }}</p>
                        <p class="post-time">{{ post.created_at|humanize }}</p>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if post.user_id == g.user.id %}
                            <li><a class="dropdown-item" href="#" onclick="editPost({{ post.id }})"><i class="bi bi-pencil me-2"></i> Edit</a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }})"><i class="bi bi-trash me-2"></i> Delete</a></li>
                            {% else %}
                            <li><a class="dropdown-item" href="#" onclick="reportPost({{ post.id }})"><i class="bi bi-flag me-2"></i> Report</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <div class="post-content">
                    {% if post.content %}
                    <div class="post-text">
                        {{ post.content }}
                    </div>
                    {% endif %}

                    {% if post.media %}
                    <div class="post-images">
                        <div class="post-image-grid grid-{{ post.media|length }}">
                            {% for media in post.media %}
                            <div class="post-image">
                                <img src="{{ media.media_url }}" alt="Post image">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="post-actions">
                    <button class="post-action-btn {% if post.user_liked %}post-liked{% endif %}" onclick="likePost({{ post.id }})">
                        <i class="bi {% if post.user_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                        <span class="post-action-count">{{ post.like_count }}</span>
                    </button>

                    <button class="post-action-btn" onclick="showComments({{ post.id }})">
                        <i class="bi bi-chat"></i>
                        <span class="post-action-count">{{ post.comment_count }}</span>
                    </button>

                    <button class="post-action-btn" onclick="sharePost({{ post.id }})">
                        <i class="bi bi-share"></i>
                    </button>
                </div>

                <!-- Comments Section (Hidden by Default) -->
                <div class="post-comments" id="comments-{{ post.id }}" style="display: none;">
                    <div class="p-3 border-top">
                        <div class="d-flex mb-3">
                            <img src="{{ g.user.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ g.user.username }}" class="post-avatar me-2">
                            <div class="flex-grow-1">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="comment-input-{{ post.id }}" placeholder="Write a comment...">
                                    <button class="btn btn-primary" onclick="addComment({{ post.id }})">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="comments-container-{{ post.id }}">
                            {% for comment in post.comments %}
                            <div class="d-flex mb-2">
                                <img src="{{ comment.user.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ comment.user.username }}" class="post-avatar me-2" style="width: 32px; height: 32px;">
                                <div>
                                    <div class="bg-dark-subtle p-2 rounded">
                                        <strong>{{ comment.user.username }}</strong>
                                        <p class="mb-0">{{ comment.content }}</p>
                                    </div>
                                    <div class="d-flex mt-1">
                                        <small class="text-muted me-3">{{ comment.created_at|humanize }}</small>
                                        <small class="text-muted me-3"><a href="#" onclick="likeComment({{ comment.id }})">Like</a></small>
                                        <small class="text-muted">{{ comment.like_count }} likes</small>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-center text-muted">No comments yet. Be the first to comment!</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="card text-center p-5">
                <div class="py-5">
                    <i class="bi bi-newspaper fs-1 text-muted mb-3"></i>
                    <h5>Welcome to SocialConnect!</h5>
                    <p class="text-muted">Your feed is empty. Start by connecting with friends to see their posts here.</p>
                    <a href="{{ url_for('auth.friends') }}" class="btn btn-primary mt-3">Find Friends</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <div class="right-sidebar">
            <!-- Friend Suggestions -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">People You May Know</h5>
                    <a href="{{ url_for('auth.friends') }}" class="text-decoration-none">See All</a>
                </div>
                <div class="card-body">
                    {% for suggestion in friend_suggestions %}
                    <div class="friend-suggestion">
                        <img src="{{ suggestion.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ suggestion.username }}" class="friend-avatar">
                        <div class="friend-info">
                            <p class="friend-username">{{ suggestion.username }}</p>
                            <p class="friend-meta">{{ suggestion.mutual_friends }} mutual friends</p>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addFriend({{ suggestion.id }})">
                            <i class="bi bi-person-plus"></i>
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No suggestions available</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Trending Tags -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Trending Topics</h5>
                </div>
                <div class="card-body">
                    {% for tag in trending_tags %}
                    <div class="tag-item">
                        <a href="{{ url_for('main.tag', tag=tag.name) }}" class="text-decoration-none">
                            #{{ tag.name }}
                        </a>
                        <span class="tag-count">{{ tag.post_count }} posts</span>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No trending topics</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Footer Links -->
            <div class="mb-4">
                <div class="d-flex flex-wrap gap-2 text-muted small">
                    <a href="#" class="text-decoration-none text-muted">About</a>
                    <a href="#" class="text-decoration-none text-muted">Privacy</a>
                    <a href="#" class="text-decoration-none text-muted">Terms</a>
                    <a href="#" class="text-decoration-none text-muted">Cookies</a>
                    <a href="#" class="text-decoration-none text-muted">Advertising</a>
                    <a href="#" class="text-decoration-none text-muted">Help</a>
                </div>
                <p class="mt-2 small text-muted">
                    {{ site_name }} &copy; {{ current_year }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Create Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex align-items-center">
                    <img src="{{ g.user.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ g.user.username }}" class="post-avatar me-2">
                    <div>
                        <strong>{{ g.user.username }}</strong>
                    </div>
                </div>

                <div class="mb-3">
                    <textarea class="form-control" id="postContent" rows="3" placeholder="What's on your mind?"></textarea>
                </div>

                <div class="mb-3">
                    <div id="imagePreviewContainer" class="d-none mb-3">
                        <div class="position-relative">
                            <div id="imagePreview" class="d-flex flex-wrap gap-2"></div>
                            <button type="button" class="btn-close position-absolute top-0 end-0" onclick="clearImagePreviews()"></button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center p-2 rounded bg-dark-subtle">
                        <div>Add to your post</div>
                        <div>
                            <button class="btn btn-sm me-2" onclick="document.getElementById('postImageUpload').click()" title="Upload to Imgur/Catbox">
                                <i class="bi bi-image text-success fs-4"></i>
                                <span class="small ms-1">Upload Photo</span>
                            </button>
                            <input type="file" id="postImageUpload" style="display: none" multiple accept="image/*" onchange="handleImageUpload(event)">

                            <button class="btn btn-sm">
                                <i class="bi bi-emoji-smile text-warning fs-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPostButton" onclick="createPost()">Post</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Story Modal -->
<div class="modal fade" id="createStoryModal" tabindex="-1" aria-labelledby="createStoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStoryModalLabel">Create Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex align-items-center">
                    <img src="{{ g.user.profile_pic or url_for('static', filename='images/default-avatar.svg') }}" alt="{{ g.user.username }}" class="post-avatar me-2">
                    <div>
                        <strong>{{ g.user.username }}</strong>
                    </div>
                </div>

                <div class="mb-3">
                    <textarea class="form-control" id="storyText" rows="3" placeholder="Add a caption to your story..."></textarea>
                </div>

                <div class="mb-3">
                    <div id="storyPreviewContainer" class="d-none mb-3">
                        <div class="position-relative">
                            <div id="storyPreview" class="text-center"></div>
                            <button type="button" class="btn-close position-absolute top-0 end-0" onclick="clearStoryPreview()"></button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center gap-3 p-3 rounded bg-dark-subtle">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('storyPhotoUpload').click()">
                            <i class="bi bi-image me-2"></i> Photo (Imgur/Catbox)
                        </button>
                        <input type="file" id="storyPhotoUpload" style="display: none" accept="image/*" onchange="handleStoryPhotoUpload(event)">

                        <button class="btn btn-outline-success" id="textStoryBtn">
                            <i class="bi bi-fonts me-2"></i> Text
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitStoryButton" onclick="createStory()">Share to Story</button>
            </div>
        </div>
    </div>
</div>

<!-- View Story Modal -->
<div class="modal fade" id="viewStoryModal" tabindex="-1" aria-labelledby="viewStoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0 position-relative">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3 bg-white" data-bs-dismiss="modal" aria-label="Close"></button>

                <div id="storyContent" class="position-relative">
                    <!-- Story content will be loaded here -->
                </div>

                <div class="story-controls position-absolute top-0 start-0 w-100 d-flex justify-content-between p-3">
                    <button class="btn btn-sm btn-light rounded-circle" id="prevStoryBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-sm btn-light rounded-circle" id="nextStoryBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    // Current story being viewed
    let currentStoryIndex = 0;
    let stories = [];

    // Files to upload with post
    let postFiles = [];
    let storyFile = null;
    let storyType = 'text';

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set up story click events
        document.querySelectorAll('.story-item').forEach(item => {
            if (!item.classList.contains('create-story')) {
                item.addEventListener('click', function() {
                    const storyId = this.dataset.storyId;
                    viewStory(storyId);
                });
            }
        });

        // Set up text story button
        document.getElementById('textStoryBtn').addEventListener('click', function() {
            clearStoryPreview();
            storyType = 'text';
            storyFile = null;

            // Show text input and customize it for text story
            const storyText = document.getElementById('storyText');
            storyText.placeholder = 'What\'s on your mind?';
            storyText.style.height = '150px';
            storyText.focus();
        });
    });

    // Like a post
    function likePost(postId) {
        fetch(`/api/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const postElement = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                const likeButton = postElement.querySelector('.post-action-btn');
                const likeIcon = likeButton.querySelector('i');
                const likeCount = likeButton.querySelector('.post-action-count');

                if (data.liked) {
                    likeButton.classList.add('post-liked');
                    likeIcon.classList.remove('bi-heart');
                    likeIcon.classList.add('bi-heart-fill');
                } else {
                    likeButton.classList.remove('post-liked');
                    likeIcon.classList.remove('bi-heart-fill');
                    likeIcon.classList.add('bi-heart');
                }

                likeCount.textContent = data.count;
            }
        })
        .catch(error => {
            console.error('Error liking post:', error);
        });
    }

    // Show comments for a post
    function showComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);

        if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';

            // Focus the comment input
            document.getElementById(`comment-input-${postId}`).focus();
        } else {
            commentsSection.style.display = 'none';
        }
    }

    // Add a comment to a post
    function addComment(postId) {
        const commentInput = document.getElementById(`comment-input-${postId}`);
        const content = commentInput.value.trim();

        if (!content) return;

        fetch(`/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                commentInput.value = '';

                // Update UI with new comment
                const commentsContainer = document.getElementById(`comments-container-${postId}`);

                // Clear "no comments" message if present
                if (commentsContainer.querySelector('p.text-center')) {
                    commentsContainer.innerHTML = '';
                }

                // Add new comment
                const commentHtml = `
                    <div class="d-flex mb-2">
                        <img src="${data.comment.user.profile_pic || '/static/images/default-avatar.svg'}" alt="${data.comment.user.username}" class="post-avatar me-2" style="width: 32px; height: 32px;">
                        <div>
                            <div class="bg-dark-subtle p-2 rounded">
                                <strong>${data.comment.user.username}</strong>
                                <p class="mb-0">${data.comment.content}</p>
                            </div>
                            <div class="d-flex mt-1">
                                <small class="text-muted me-3">Just now</small>
                                <small class="text-muted me-3"><a href="#" onclick="likeComment(${data.comment.id})">Like</a></small>
                                <small class="text-muted">0 likes</small>
                            </div>
                        </div>
                    </div>
                `;

                commentsContainer.insertAdjacentHTML('afterbegin', commentHtml);

                // Update comment count
                const commentCountElement = document.querySelector(`.post-card[data-post-id="${postId}"] .post-action-btn:nth-child(2) .post-action-count`);
                commentCountElement.textContent = parseInt(commentCountElement.textContent) + 1;
            }
        })
        .catch(error => {
            console.error('Error adding comment:', error);
        });
    }

    // Like a comment
    function likeComment(commentId) {
        fetch(`/api/comments/${commentId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI is more complex here since we don't have a direct reference
                // A full implementation would update the comment like count and styling
                alert('Comment like status updated');
            }
        })
        .catch(error => {
            console.error('Error liking comment:', error);
        });
    }

    // Share a post
    function sharePost(postId) {
        // A full implementation would show a sharing dialog
        alert('Sharing functionality coming soon!');
    }

    // Edit a post
    function editPost(postId) {
        // A full implementation would populate and show the edit modal
        alert('Edit functionality coming soon!');
    }

    // Delete a post
    function deletePost(postId) {
        if (confirm('Are you sure you want to delete this post? This cannot be undone.')) {
            fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove post from UI
                    const postElement = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                    postElement.remove();
                }
            })
            .catch(error => {
                console.error('Error deleting post:', error);
            });
        }
    }

    // Report a post
    function reportPost(postId) {
        // A full implementation would show a reporting form
        alert('Report functionality coming soon!');
    }

    // Add a friend
    function addFriend(userId) {
        fetch(`/api/friends/request`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                const button = document.querySelector(`.friend-suggestion button[onclick="addFriend(${userId})"]`);
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Pending';
                button.disabled = true;
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
            }
        })
        .catch(error => {
            console.error('Error adding friend:', error);
        });
    }

    // Handle image upload for posts
    function handleImageUpload(event) {
        const files = event.target.files;
        if (!files.length) return;

        // Limit to 5 images
        if (files.length > 5) {
            alert('You can upload a maximum of 5 images per post');
            return;
        }

        // Check file sizes (limit to 5MB each)
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        for (const file of files) {
            if (file.size > MAX_FILE_SIZE) {
                alert(`File ${file.name} is too large. Maximum size is 5MB per image.`);
                return;
            }
        }

        // Store files for later upload
        postFiles = Array.from(files);

        // Show previews
        const previewContainer = document.getElementById('imagePreviewContainer');
        const preview = document.getElementById('imagePreview');

        preview.innerHTML = '';

        for (const file of files) {
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.title = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;

                preview.appendChild(img);
            };

            reader.readAsDataURL(file);
        }

        previewContainer.classList.remove('d-none');
    }

    // Clear image previews
    function clearImagePreviews() {
        postFiles = [];
        document.getElementById('imagePreviewContainer').classList.add('d-none');
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('postImageUpload').value = '';
    }

    // Handle photo upload for stories
    function handleStoryPhotoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file size (limit to 5MB)
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        if (file.size > MAX_FILE_SIZE) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return;
        }

        storyType = 'image';
        storyFile = file;

        // Show preview
        const previewContainer = document.getElementById('storyPreviewContainer');
        const preview = document.getElementById('storyPreview');

        const reader = new FileReader();

        reader.onload = function(e) {
            preview.innerHTML = '';

            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '300px';
            img.style.borderRadius = '8px';
            img.title = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;

            // Add file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'mt-2 small text-muted';
            fileInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB) - Will be uploaded to Imgur/Catbox`;
            preview.appendChild(img);
            preview.appendChild(fileInfo);
            previewContainer.classList.remove('d-none');
        };

        reader.readAsDataURL(file);
    }

    // We don't support video uploads anymore

    // Clear story preview
    function clearStoryPreview() {
        storyFile = null;
        storyType = 'text';
        document.getElementById('storyPreviewContainer').classList.add('d-none');
        document.getElementById('storyPreview').innerHTML = '';
        document.getElementById('storyPhotoUpload').value = '';

        // Reset text input
        const storyText = document.getElementById('storyText');
        storyText.placeholder = 'Add a caption to your story...';
        storyText.style.height = '';
    }

    // Create a post
    function createPost() {
        const content = document.getElementById('postContent').value.trim();

        if (!content && postFiles.length === 0) {
            alert('Please add some text or images to your post');
            return;
        }

        // Disable submit button
        const submitButton = document.getElementById('submitPostButton');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Posting...';

        // Create form data for files
        const formData = new FormData();
        formData.append('content', content);

        if (postFiles.length > 0) {
            // Show upload message
            const statusMsg = document.createElement('div');
            statusMsg.className = 'alert alert-info mt-2';
            statusMsg.innerHTML = `Uploading ${postFiles.length} image(s) to Imgur/Catbox... This may take a moment.`;
            document.querySelector('#createPostModal .modal-body').appendChild(statusMsg);

            for (let i = 0; i < postFiles.length; i++) {
                formData.append('media', postFiles[i]);
            }
        }

        fetch('/api/posts', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
                modal.hide();

                // Clear form
                document.getElementById('postContent').value = '';
                clearImagePreviews();

                // Refresh posts (could also just add the new post to the UI)
                location.reload();
            } else {
                alert('Error creating post: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating post:', error);
            alert('Error creating post. Please try again.');
        })
        .finally(() => {
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = 'Post';

            // Remove status message if it exists
            const statusMsg = document.querySelector('#createPostModal .modal-body .alert');
            if (statusMsg) statusMsg.remove();
        });
    }

    // Create a story
    function createStory() {
        const text = document.getElementById('storyText').value.trim();

        if (storyType === 'text' && !text) {
            alert('Please add some text to your story');
            return;
        }

        // Disable submit button
        const submitButton = document.getElementById('submitStoryButton');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sharing...';

        // Create form data
        const formData = new FormData();
        formData.append('content', text);
        formData.append('story_type', storyType);

        if (storyFile) {
            formData.append('media', storyFile);
            // Show upload message
            const statusMsg = document.createElement('div');
            statusMsg.className = 'alert alert-info mt-2';
            statusMsg.innerHTML = 'Uploading image to Imgur/Catbox... This may take a moment.';
            document.querySelector('.modal-body').appendChild(statusMsg);
        }

        fetch('/api/stories', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createStoryModal'));
                modal.hide();

                // Clear form
                document.getElementById('storyText').value = '';
                clearStoryPreview();

                // Refresh stories
                location.reload();
            } else {
                alert('Error creating story: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating story:', error);
            alert('Error creating story. Please try again.');
        })
        .finally(() => {
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = 'Share to Story';

            // Remove status message if it exists
            const statusMsg = document.querySelector('.modal-body .alert');
            if (statusMsg) statusMsg.remove();
        });
    }

    // View a story
    function viewStory(storyId) {
        fetch(`/api/stories/${storyId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store all user stories for navigation
                stories = data.user_stories;

                // Find index of current story
                currentStoryIndex = stories.findIndex(s => s.id === parseInt(storyId));

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewStoryModal'));
                modal.show();

                // Display story
                displayStory(stories[currentStoryIndex]);
            }
        })
        .catch(error => {
            console.error('Error fetching story:', error);
        });
    }

    // Display a story in the view modal
    function displayStory(story) {
        const storyContent = document.getElementById('storyContent');

        // Clear previous content
        storyContent.innerHTML = '';

        // Set up header with user info and timestamp
        const header = document.createElement('div');
        header.className = 'story-header position-absolute top-0 start-0 w-100 d-flex align-items-center p-3';
        header.innerHTML = `
            <img src="${story.author.profile_pic || '/static/images/default-avatar.svg'}" alt="${story.author.username}" class="post-avatar me-2">
            <div class="text-white">
                <strong>${story.author.username}</strong>
                <div><small>${formatTimeAgo(story.created_at)}</small></div>
            </div>
        `;

        // Create content based on story type
        let content;

        if (story.story_type === 'image') {
            content = document.createElement('img');
            content.src = story.media_url;
            content.style.width = '100%';
            content.style.height = 'auto';
            content.style.maxHeight = '80vh';
            content.style.objectFit = 'contain';
        } else {
            // Text story
            content = document.createElement('div');
            content.className = 'text-story d-flex align-items-center justify-content-center';
            content.style.height = '60vh';
            content.style.backgroundColor = '#333';
            content.style.color = 'white';
            content.style.padding = '20px';
            content.style.fontSize = '1.5rem';
            content.style.textAlign = 'center';
            content.innerHTML = `<p>${story.content}</p>`;
        }

        // Add caption if available
        if (story.content && story.story_type !== 'text') {
            const caption = document.createElement('div');
            caption.className = 'story-caption position-absolute bottom-0 start-0 w-100 p-3 bg-dark bg-opacity-50 text-white';
            caption.innerHTML = `<p class="mb-0">${story.content}</p>`;
            storyContent.appendChild(caption);
        }

        // Add to story content
        storyContent.appendChild(content);
        storyContent.appendChild(header);

        // Set up navigation buttons
        document.getElementById('prevStoryBtn').style.visibility = currentStoryIndex > 0 ? 'visible' : 'hidden';
        document.getElementById('nextStoryBtn').style.visibility = currentStoryIndex < stories.length - 1 ? 'visible' : 'hidden';

        // Set up event listeners for navigation
        document.getElementById('prevStoryBtn').onclick = navigateToPrevStory;
        document.getElementById('nextStoryBtn').onclick = navigateToNextStory;

        // Auto advance to next story for images and text
        if (story.story_type !== 'video') {
            setTimeout(() => {
                if (currentStoryIndex < stories.length - 1) {
                    navigateToNextStory();
                } else {
                    // Close modal if last story
                    const modal = bootstrap.Modal.getInstance(document.getElementById('viewStoryModal'));
                    modal.hide();
                }
            }, 5000);
        }

        // Mark story as viewed
        fetch(`/api/stories/${story.id}/view`, {
            method: 'POST'
        }).catch(error => console.error('Error marking story as viewed:', error));
    }

    // Navigate to previous story
    function navigateToPrevStory() {
        if (currentStoryIndex > 0) {
            currentStoryIndex--;
            displayStory(stories[currentStoryIndex]);
        }
    }

    // Navigate to next story
    function navigateToNextStory() {
        if (currentStoryIndex < stories.length - 1) {
            currentStoryIndex++;
            displayStory(stories[currentStoryIndex]);
        } else {
            // Close modal if last story
            const modal = bootstrap.Modal.getInstance(document.getElementById('viewStoryModal'));
            modal.hide();
        }
    }

    // Format time ago (e.g. "2 hours ago")
    function formatTimeAgo(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.round(diffMs / 1000);
        const diffMin = Math.round(diffSec / 60);
        const diffHour = Math.round(diffMin / 60);

        if (diffSec < 60) {
            return `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
        } else if (diffMin < 60) {
            return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
        } else if (diffHour < 24) {
            return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
        } else {
            return date.toLocaleDateString();
        }
    }
</script>
{% endblock %}